<modification>    <name>POS Opencart Modifications</name>	<code>pos_opencart_modifications</code>    <version>1.0</version>    <author>TheOne POS: support@pos4opencart.com</author>	<!-- POS menu -->    <file path="admin/view/template/common/header.tpl">		<operation>			<search><![CDATA[<script type="text/javascript" src="view/javascript/bootstrap/js/bootstrap.min.js"></script>]]></search>			<add position="before"><![CDATA[				<link rel="stylesheet" type="text/css" href="view/javascript/jquery/ui/jquery-ui.min.css" />				<script type="text/javascript" src="view/javascript/jquery/ui/jquery-ui.min.js"></script>				]]></add>		</operation>	</file>    <file path="admin/controller/common/menu.php">		<operation>			<search><![CDATA[$data['order_recurring'] = $this->url->link('sale/recurring', 'token=' . $this->session->data['token'], 'SSL');]]></search>			<add position="after"><![CDATA[			$data['pos_console'] = $this->url->link('module/pos/main', 'token=' . $this->session->data['token'], 'SSL');			$data['pos_settings'] = $this->url->link('module/pos', 'token=' . $this->session->data['token'], 'SSL');			$data['pos_stock_manager'] = $this->url->link('module/pos/stock_manager', 'token=' . $this->session->data['token'], 'SSL');			$data['pos_payment_summary'] = $this->url->link('report/order_payment/summary', 'token=' . $this->session->data['token'], 'SSL');			$data['pos_payment_details'] = $this->url->link('report/order_payment', 'token=' . $this->session->data['token'], 'SSL');			$data['pos_extended_product'] = $this->url->link('pos/extended_product', 'token=' . $this->session->data['token'], 'SSL');			$data['pos_commission_summary'] = $this->url->link('report/pos_commission/summary', 'token=' . $this->session->data['token'], 'SSL');			$data['pos_commission_details'] = $this->url->link('report/pos_commission', 'token=' . $this->session->data['token'], 'SSL');			$data['pos_clean_tables'] = $this->url->link('pos/clean_tables', 'token=' . $this->session->data['token'], 'SSL');			$data['pos_sn_manager'] = $this->url->link('pos/sn_manager', 'token=' . $this->session->data['token'], 'SSL');			$data['is_pos_user'] = (empty($this->session->data['is_pos_user'])) ? 0 : 1;			$data['pos_export_report_sales'] = $this->url->link('module/pos/export_report_csv', 'token=' . $this->session->data['token'] . '&type=sales', 'SSL');			$data['pos_export_report_stock'] = $this->url->link('module/pos/export_report_csv', 'token=' . $this->session->data['token'] . '&type=stock', 'SSL');			]]></add>		</operation>	</file>    <file path="admin/view/template/common/menu.tpl">		<operation>			<search><![CDATA[<ul id="menu">]]></search>			<add position="after"><![CDATA[			<?php if (empty($is_pos_user)) { ?>]]></add>		</operation>		<operation>			<search><![CDATA[<li id="catalog">]]></search>			<add position="before"><![CDATA[<li id="pos"><a class="parent"><i class="fa fa-desktop fa-fw"></i> <span>Point Of Sale</span></a>					<ul>						<li id="pos_console"><a href="<?php echo $pos_console; ?>">POS Console</a></li>						<li id="pos_settings"><a href="<?php echo $pos_settings; ?>">POS Settings</a></li>						<li id="pos_stock_manager"><a href="<?php echo $pos_stock_manager; ?>">POS Stock Manager</a></li>						<li><a class="parent">POS Report</a>							<ul>								<li><a id="pos_payment_summary" onclick="var browser_time = (new Date()).getTime(); location='<?php echo $pos_payment_summary; ?>&browser_time='+browser_time;">Payment Summary</a></li>								<li><a id="pos_payment_details" onclick="var browser_time = (new Date()).getTime(); location='<?php echo $pos_payment_details; ?>&browser_time='+browser_time;">Payment Details</a></li>								<li><a id="pos_commission_summary" onclick="var browser_time = (new Date()).getTime(); location='<?php echo $pos_commission_summary; ?>&browser_time='+browser_time;">Commission Summary</a></li>								<li><a id="pos_commission_details" onclick="var browser_time = (new Date()).getTime(); location='<?php echo $pos_commission_details; ?>&browser_time='+browser_time;">Commission Details</a></li>								<li><a onclick="promptReportDates();">Export Sales Report</a></li>								<li><a href="<?php echo $pos_export_report_stock; ?>">Export Stock Report</a></li>							</ul>						</li>						<li id="pos_extended_product"><a href="<?php echo $pos_extended_product; ?>">POS Product Extension</a></li>						<li id="pos_extended_product"><a href="<?php echo $pos_clean_tables; ?>">Clean POS Tables</a></li>						<li id="pos_extended_product"><a href="<?php echo $pos_sn_manager; ?>">Serial No. Manager</a></li>					</ul>				</li>				<script type="text/javascript">					function promptReportDates() {						var html = '<div id="export_sales_report_dialog" title="Select Date Range" style="overflow: hidden; ">';						html += '<form class="form-horizontal" role="form">';						html += '<div class="form-group">';						html += '<label class="control-label col-sm-4" for="startDate">Start Date:</label>';						html += '<div class="col-sm-6"><input type="text" class="form-control" id="startDate" data-format="YYYY-MM-DD" data-date-format="YYYY-MM-DD"></div>';						html += '</div>';						html += '<div class="form-group">';						html += '<label class="control-label col-sm-4" for="endDate">End Date:</label>';						html += '<div class="col-sm-6"><input type="text" class="form-control" id="endDate" data-format="YYYY-MM-DD" data-date-format="YYYY-MM-DD"></div>';						html += '</div>';						html += '<div class="form-group">';						html += '<div class="col-sm-offset-4 col-sm-6"><button type="button" id="exportButton" onclick="exportSalesReport()" class="btn btn-default">Export</button></div>'						html += '</div></form>';						html += '</div>';						$(html).dialog({							modal: true,							width: 420,							height: 220,							buttons: {},							close: function() {								$('#export_sales_report_dialog').remove();							}						});						var today = formatDate(new Date());						$('#startDate').val(today);						$('#endDate').val(today);						$('#startDate').datetimepicker({pickTime: false});						$('#endDate').datetimepicker({pickTime: false});						$('#exportButton').focus();					};					function exportSalesReport() {						var startDate = $('#startDate').val();						var endDate = $('#endDate').val();						$('#export_sales_report_dialog').dialog('close');						$('#export_sales_report_dialog').remove();						location = $('<div/>').html('<?php echo $pos_export_report_sales; ?>').text() + '&startDate=' + startDate + '&endDate=' + endDate;					};					function formatDate(date) {						var month = date.getMonth()+1;						var day = date.getDate();						month = ( month < 10 ? "0" : "" ) + month;						day = ( day < 10 ? "0" : "" ) + day;												return  date.getFullYear() + '-' + month + '-' + day;					};				</script>				]]></add>		</operation>		<operation>			<search regex="true"><![CDATA[#<\/ul>(?!.*<\/ul>)#s]]></search>			<add><![CDATA[<?php } else { ?>				<li id="pos"><a class="parent"><i class="fa fa-desktop fa-fw"></i> <span>Point Of Sale</span></a>					<ul>						<li id="pos_settings"><a href="<?php echo $pos_console; ?>">Console</a></li>						<li><a href="<?php echo $pos_payment_summary; ?>">Payment Summary</a></li>					</ul>				</li>				<?php } ?></ul>]]>			</add>		</operation>    </file>	<!-- POS auto redirection -->    <file path="admin/controller/common/login.php">		<operation>			<search><![CDATA[if ($this->user->isLogged() && isset($this->request->get['token']) && ($this->request->get['token'] == $this->session->data['token'])) {]]></search>			<add position="after"><![CDATA[			$this->pos_redirect();]]></add>		</operation>		<operation>			<search><![CDATA[$this->session->data['token'] = md5(mt_rand());]]></search>			<add position="after"><![CDATA[			$this->pos_redirect();]]></add>		</operation>		<operation>			<search><![CDATA[protected function validate() {]]></search>			<add position="before"><![CDATA[			public function pos_redirect() {				$this->session->data['pos_user_login'] = 1;				$this->load->model('setting/setting');				$pos_settings = $this->model_setting_setting->getSetting('POS');				$excluded_groups = array();				if (isset($pos_settings['POS_excluded_groups'])) {					$excluded_groups = $pos_settings['POS_excluded_groups'];				}				$this->load->model('user/user');				$user = $this->model_user_user->getUser($this->user->getId());				$user_group_id = 0;				if ($user) {					$user_group_id = $user['user_group_id'];					$this->load->model('user/user_group');					$user_group = $this->model_user_user_group->getUserGroup($user_group_id);					if ($user_group && $user_group['name'] == 'POS') {						$this->session->data['is_pos_user'] = 1;					} else {						$this->session->data['is_pos_user'] = 0;					}					if ($user_group && $user_group['name'] == 'label') {						$this->session->data['is_label_user'] = 1;					} else {						$this->session->data['is_label_user'] = 0;					}				}				if ($pos_settings && isset($pos_settings['POS_display_once_login']) && $pos_settings['POS_display_once_login'] == '1' && !in_array($user_group_id, $excluded_groups)) {					$this->response->redirect($this->url->link('module/pos/main', 'token=' . $this->session->data['token'], 'SSL'));				} else {					$this->response->redirect($this->url->link('common/dashboard', 'token=' . $this->session->data['token'], 'SSL'));				}			}			]]></add>		</operation>    </file>    <file path="system/engine/front.php">		<operation>			<search><![CDATA[while ($action) {]]></search>			<add position="before"><![CDATA[$actionClass = $action->getClass();			$actionMethod = $action->getMethod();			if (isset($this->registry->get('session')->data['user_id']) && $actionClass != 'Controllercommonlogout' && $actionClass != 'Controllercommonlogin'			&& $actionClass != 'Controllerposshipping' && $actionClass != 'Controllerreportorderpayment' && $actionClass != 'Controllersalecustomer') {				if ($actionClass != 'Controllermodulepos' || ($actionClass == 'Controllermodulepos' && $actionMethod == 'index')) {				$user_id = $this->registry->get('session')->data['user_id'];				$query = $this->registry->get('db')->query("SELECT g.name FROM `" . DB_PREFIX . "user` u LEFT JOIN " . DB_PREFIX . "user_group g ON u.user_group_id = g.user_group_id WHERE u.user_id = '" . $user_id . "'");				if ($query->row && $query->row['name'] == 'POS') {					$action = new Action('module/pos/main');				}			}		}		]]></add>		</operation>    </file>    <file path="system/engine/action.php">		<operation>			<search><![CDATA[public function execute($registry) {]]></search>			<add position="before"><![CDATA[public function getClass() {				return $this->class;			}			public function getMethod() {				return $this->method;			}			]]></add>		</operation>    </file>	<!-- POS cart alteration -->    <file path="system/library/cart.php">		<operation>			<search><![CDATA[public function getProducts()]]></search>			<add position="before"><![CDATA[public function add_pos_products($order_products) {				$this->data['pos_products'] = $order_products;			}			]]></add>		</operation>		<operation>			<search><![CDATA[public function getProducts() {]]></search>			<add position="after"><![CDATA[if (!empty($this->session->data['pos_cart'])) {				$products = array();				$pos_products = array();				if (!empty($this->session->data['pos_products'])) {					$pos_products =  $this->session->data['pos_products'];				} elseif (!empty($this->data['pos_products'])) {					$pos_products = $this->data['pos_products'];				}								foreach ($pos_products as $product) {					if (!empty($product['discount'])) {						$product['price'] = $product['discount']['discounted_price'];						$product['tax'] = $product['discount']['discounted_tax'];						$product['total'] = $product['discount']['discounted_total'];					}					$products[] = $product;				}				return $products;			}			]]></add>		</operation>    </file>	<!-- POS currency function -->    <file path="system/library/currency.php">		<operation>			<search><![CDATA[public function format(]]></search>			<add position="before"><![CDATA[public function formatFront($number, $currency = '', $value = '', $format = true) {		if ($currency && $this->has($currency)) {      		$symbol_left   = $this->currencies[$currency]['symbol_left'];      		$symbol_right  = $this->currencies[$currency]['symbol_right'];      		$decimal_place = $this->currencies[$currency]['decimal_place'];    	} else {      		$symbol_left   = $this->currencies[$this->code]['symbol_left'];      		$symbol_right  = $this->currencies[$this->code]['symbol_right'];      		$decimal_place = $this->currencies[$this->code]['decimal_place'];						$currency = $this->code;    	}    	if ($value) {      		$value = $value;    	} else {      		$value = $this->currencies[$currency]['value'];    	}    	if ($value) {      		$value = (float)$number * $value;    	} else {      		$value = $number;    	}    	$string = '';    	if (($symbol_left) && ($format)) {      		$string .= $symbol_left;    	}		if ($format) {			$decimal_point = $this->language->get('decimal_point');		} else {			$decimal_point = '.';		}				if ($format) {			$thousand_point = $this->language->get('thousand_point');		} else {			$thousand_point = '';		}				if (isset($this->session->data['text_decimal_point']) && isset($this->session->data['text_thousand_point'])) {			$decimal_point = $this->session->data['text_decimal_point'];			$thousand_point = $this->session->data['text_thousand_point'];		}		    	$string .= number_format(round($value, (int)$decimal_place), (int)$decimal_place, $decimal_point, $thousand_point);    	if (($symbol_right) && ($format)) {      		$string .= $symbol_right;    	}    	return $string;  	}]]></add>		</operation>    </file>	<!-- POS customer loyalty card support -->    <file path="admin/view/template/sale/customer_form.tpl">		<operation>			<search><![CDATA[<div class="tab-pane active" id="tab-customer">]]></search>			<add position="after"><![CDATA[<div class="form-group">                        <label class="col-sm-2 control-label" for="input-card_number"><?php echo $entry_card_number; ?></label>                        <div class="col-sm-10">                          <input type="text" name="card_number" value="<?php echo $card_number; ?>" placeholder="<?php echo substr($entry_card_number, 0, -1); ?>" id="input-card_number" class="form-control" />                        </div>                      </div>]]></add>		</operation>    </file>    <file path="admin/controller/sale/customer.php">		<operation>			<search><![CDATA[if (isset($this->request->post['firstname'])) {]]></search>			<add position="before"><![CDATA[$this->language->load('module/pos');		$data['entry_card_number'] = $this->language->get('entry_card_number');		if (isset($this->request->post['card_number'])) {      		$data['card_number'] = $this->request->post['card_number'];		} elseif (!empty($customer_info)) { 			$data['card_number'] = $customer_info['card_number'];		} else {      		$data['card_number'] = '';    	}]]></add>		</operation>    </file>    <file path="admin/model/sale/customer.php">		<operation>			<search><![CDATA[if ($data['password']) {]]></search>			<add position="before"><![CDATA[if ($data['card_number']) {        	$this->db->query("UPDATE " . DB_PREFIX . "customer SET card_number = '" . $this->db->escape($data['card_number']) . "' WHERE customer_id = '" . (int)$customer_id . "'");      	}]]></add>		</operation>    </file>	<!-- POS hide non-catalog product from opencart product page -->    <file path="admin/model/catalog/product.php">		<operation>			<search><![CDATA[$sql .= " GROUP BY p.product_id";]]></search>			<add position="before"><![CDATA[			$sql .= " AND p.quick_sale <> '2'";			]]></add>		</operation>		<operation>			<search><![CDATA[$sql .= " WHERE pd.language_id = '" . (int)$this->config->get('config_language_id') . "'";]]></search>			<add position="after"><![CDATA[			$sql .= " AND p.quick_sale <> '2'";			]]></add>		</operation>	</file>	<!-- POS offline support -->    <file path="admin/controller/common/login.php">		<operation>			<search><![CDATA[$this->response->setOutput($this->load->view('common/login.tpl', $data));]]></search>			<add position="before"><![CDATA[if (!file_exists(DIR_APPLICATION . 'view/template/pos/offline/login.html')) { file_put_contents(DIR_APPLICATION . 'view/template/pos/offline/login.html', $this->load->view('common/login.tpl', $data)); }			]]></add>		</operation>		<operation>			<search><![CDATA[$data['action'] = $this->url->link('common/login', '', 'SSL');]]></search>			<add position="before"><![CDATA[if (isset($this->request->server['HTTPS']) && (($this->request->server['HTTPS'] == 'on') || ($this->request->server['HTTPS'] == '1'))) {				$data['ajax_action'] = HTTPS_SERVER . 'controller/pos/ajax_login.php';			} else {				$data['ajax_action'] = HTTP_SERVER . 'controller/pos/ajax_login.php';			}			]]></add>		</operation>	</file>    <file path="admin/view/template/common/login.tpl">		<operation>			<search><![CDATA[<button type="submit" class="btn btn-primary"><i class="fa fa-key"></i> <?php echo $button_login; ?></button>]]></search>			<add position="replace"><![CDATA[<button type="button" onclick="ajaxLogin();" class="btn btn-primary"><i class="fa fa-key"></i> <?php echo $button_login; ?></button>]]></add>		</operation>		<operation>			<search><![CDATA[<?php echo $footer; ?>]]></search>			<add position="before"><![CDATA[<script src="view/javascript/pos/md5.js" type="text/javascript"></script>			<script type="text/javascript">				function ajaxLogin() {					var data = {};					$('form input').each(function() {						data[$(this).attr('name')] = $(this).val();					});					$.ajax({						url: '<?php echo $ajax_action; ?>',						type: 'post',						dataType: 'json',						data: data,						success: function (json) {							if (json['success']) {								localStorage.setItem('pos_local_hash', md5(data['username'] + data['password']));							}							$('form').submit();						}					});				}			</script>]]></add>		</operation>	</file>	<!-- hide instore shipping and payment method from front store -->    <file path="catalog/controller/checkout/payment_method.php">		<operation>			<search><![CDATA[if ($this->config->get($result['code'] . '_status')) {]]></search>			<add position="replace"><![CDATA[if ($this->config->get($result['code'] . '_status') && $result['code'] != 'in_store') {]]></add>		</operation>    </file>    <file path="catalog/controller/checkout/shipping_method.php">		<operation>			<search><![CDATA[if ($this->config->get($result['code'] . '_status')) {]]></search>			<add position="replace"><![CDATA[if ($this->config->get($result['code'] . '_status') && $result['code'] != 'instore') {]]></add>		</operation>    </file>    <file path="admin/controller/extension/module.php">		<operation>			<search><![CDATA[$this->model_setting_setting->deleteSetting($this->request->get['extension']);]]></search>			<add position="replace"><![CDATA[if ($this->request->get['extension'] != 'pos') { $this->model_setting_setting->deleteSetting($this->request->get['extension']); }]]></add>		</operation>    </file></modification>